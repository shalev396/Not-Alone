name: CI/CD Pipeline # Name of the GitHub Actions Workflow

# ðŸš€ Workflow Triggers: When to run this workflow
on:
  pull_request:
    branches: [main] # Run tests & build when a PR is made to 'main'
  push:
    branches: [main] # Run deployment when code is merged into 'main'

jobs:
  # âœ… JOB 1: Run Tests (Backend Only)
  test:
    runs-on: ubuntu-22.04 # Use Ubuntu as the runner
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3 # Get the latest code from the repo

      - name: Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18" # Ensure we're using Node.js 18

      - name: Install MongoDB CLI (Ubuntu 22.04)
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg curl

          # Correctly Add MongoDB's Updated GPG Key
          curl -fsSL https://pgp.mongodb.com/server-7.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-keyring.gpg

          # Add MongoDB APT Repository (Official MongoDB Source)
          echo "deb [signed-by=/usr/share/keyrings/mongodb-server-keyring.gpg] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list

          sudo apt-get update
          sudo apt-get install -y mongodb-org-shell mongodb-mongosh

      - name: Verify MongoDB Installation
        run: |
          mongosh --version
          mongo --version || echo "âŒ Warning: Legacy MongoDB shell is not installed."

      # ðŸš« No frontend tests, but keeping the structure for future use
      # - name: Install Frontend Dependencies
      #   run: |
      #     cd client
      #     npm install  # Install frontend dependencies

      # - name: Run Frontend Tests
      #   run: |
      #     cd client
      #     npm test  # Run frontend tests (disabled)

      - name: Install Backend Dependencies # Install backend dependencies
        run: |
          cd Server
          npm install

      - name: Check & Log Environment Variables
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.JWT_SECRET }}" ]; then echo "âŒ MISSING: JWT_SECRET"; fi
          if [ -z "${{ secrets.PASSWORD_KEY }}" ]; then echo "âŒ MISSING: PASSWORD_KEY"; fi
          if [ -z "${{ secrets.MONGODB_URI_TEST }}" ]; then echo "âŒ MISSING: MONGODB_URI_TEST"; fi
          if [ -z "${{ secrets.SMTP_HOST }}" ]; then echo "âŒ MISSING: SMTP_HOST"; fi
          if [ -z "${{ secrets.SMTP_PORT }}" ]; then echo "âŒ MISSING: SMTP_PORT"; fi
          if [ -z "${{ secrets.SMTP_USER }}" ]; then echo "âŒ MISSING: SMTP_USER"; fi
          if [ -z "${{ secrets.SMTP_PASS }}" ]; then echo "âŒ MISSING: SMTP_PASS"; fi
          if [ -z "${{ secrets.DEVICE_TOKEN_SECRET }}" ]; then echo "âŒ MISSING: DEVICE_TOKEN_SECRET"; fi
          if [ -z "${{ secrets.ENCRYPTION_KEY }}" ]; then echo "âŒ MISSING: ENCRYPTION_KEY"; fi

      - name: Set Environment Variables
        run: |
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $GITHUB_ENV
          echo "PASSWORD_KEY=${{ secrets.PASSWORD_KEY }}" >> $GITHUB_ENV
          echo "MONGODB_URI_TEST=${{ secrets.MONGODB_URI_TEST }}" >> $GITHUB_ENV
          echo "SMTP_HOST='${{ secrets.SMTP_HOST }}'" >> $GITHUB_ENV
          echo "SMTP_PORT='${{ secrets.SMTP_PORT }}'" >> $GITHUB_ENV
          echo "SMTP_USER='${{ secrets.SMTP_USER }}'" >> $GITHUB_ENV
          echo "SMTP_PASS='${{ secrets.SMTP_PASS }}'" >> $GITHUB_ENV
          echo "DEVICE_TOKEN_SECRET='${{ secrets.DEVICE_TOKEN_SECRET }}'" >> $GITHUB_ENV
          echo "ENCRYPTION_KEY='${{ secrets.ENCRYPTION_KEY }}'" >> $GITHUB_ENV

      - name: Debug MongoDB URI
        run: |
          echo "MongoDB URI: ${MONGODB_URI_TEST:0:20}********"  # Mask for security

      - name: Test MongoDB Connection
        run: |
          echo "Testing MongoDB connection..."
          echo "MongoDB URI: ${MONGODB_URI_TEST:0:20}********"  # Mask for security
          mongosh "$MONGODB_URI_TEST" --eval "db.runCommand({ connectionStatus: 1 })"

      - name: Run Backend Tests # Run backend tests
        run: |
          cd Server
          npm test

  # âœ… JOB 2: Build the Frontend (Acts as a Test)
  build:
    runs-on: ubuntu-latest
    needs: test # Runs only if backend tests pass
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Build Frontend # Create the production build (output is in 'client/dist')
        run: |
          cd client
          npm run build

  # âœ… JOB 3: Deploy Frontend to S3
  deploy_frontend:
    runs-on: ubuntu-latest
    needs: build # Runs only if build is successful
    if: github.ref == 'refs/heads/main' # Only deploy when pushing to 'main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to S3 # Sync the built frontend files to the S3 bucket
        uses: jakejarvis/s3-sync-action@master # AWS S3 sync action
        with:
          args: --delete # Remove old files from S3
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }} # S3 Bucket Name
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} # AWS Key
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # AWS Secret
          AWS_REGION: "eu-central-1" # Change to your AWS region
          SOURCE_DIR: "client/dist" # Only upload the built frontend files

  # âœ… JOB 4: Deploy Backend to EC2
  deploy_backend:
    runs-on: ubuntu-latest
    needs: build # Runs only if build is successful
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }} # SSH Private Key for EC2
          HOST: ${{ secrets.EC2_HOST }} # EC2 Public IP
          USER: "ec2-user" # EC2 User (default for Amazon Linux)
        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key  # Save private key
          scp -o StrictHostKeyChecking=no -i private_key -r Server $USER@$HOST:/home/ec2-user/backend  # Copy backend files
          ssh -o StrictHostKeyChecking=no -i private_key $USER@$HOST << 'EOF'
            cd /home/ec2-user/backend
            npm install  # Install backend dependencies
            pm2 restart all  # Restart backend service
          EOF

  # âœ… JOB 5: Notify on Discord After Deployment
  notify:
    runs-on: ubuntu-latest
    needs: [deploy_frontend, deploy_backend] # Only run after both deployments
    steps:
      - name: Send Discord Notification
        uses: Ilshidur/action-discord@2.0.0
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }} # Discord Webhook URL
          message: "ðŸš€ Deployment of Not-Alone is complete! New version is live!"
